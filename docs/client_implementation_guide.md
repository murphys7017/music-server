# å®¢æˆ·ç«¯å®ç°æŒ‡å—

æœ¬æ–‡æ¡£ä¸ºå®¢æˆ·ç«¯å¼€å‘è€…æä¾›å®Œæ•´çš„å®ç°æŒ‡å—ï¼Œå¸®åŠ©ä½ å¿«é€Ÿé›†æˆéŸ³ä¹æœåŠ¡å™¨ã€‚

---

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æœ¬åœ°æ•°æ®åº“è®¾è®¡](#æœ¬åœ°æ•°æ®åº“è®¾è®¡)
- [åˆå§‹åŒ–æµç¨‹](#åˆå§‹åŒ–æµç¨‹)
- [éŸ³ä¹æ·»åŠ æµç¨‹](#éŸ³ä¹æ·»åŠ æµç¨‹)
- [èµ„æºè·å–ç­–ç•¥](#èµ„æºè·å–ç­–ç•¥)
- [API è°ƒç”¨ç¤ºä¾‹](#api-è°ƒç”¨ç¤ºä¾‹)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### å®¢æˆ·ç«¯-æœåŠ¡å™¨äº¤äº’æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å®¢æˆ·ç«¯åº”ç”¨                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æœ¬åœ°æ•°æ®åº“ (SQLite)                â”‚  â”‚
â”‚  â”‚  - UUID â†’ æ–‡ä»¶è·¯å¾„æ˜ å°„              â”‚  â”‚
â”‚  â”‚  - ç¼“å­˜ä¿¡æ¯                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  èµ„æºç®¡ç†å™¨                         â”‚  â”‚
â”‚  â”‚  - ä¼˜å…ˆæœ¬åœ°                         â”‚  â”‚
â”‚  â”‚  - é™çº§æœåŠ¡å™¨                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ HTTPS
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Music Server (æœåŠ¡å™¨)             â”‚
â”‚  - å­˜å‚¨å…ƒæ•°æ®                            â”‚
â”‚  - æä¾›è®¾å¤‡ç®¡ç†                          â”‚
â”‚  - ä¸å­˜å‚¨æ–‡ä»¶è·¯å¾„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒåŸåˆ™

1. **éšç§ä¿æŠ¤**: æ–‡ä»¶è·¯å¾„ä¸ä¸Šä¼ ï¼Œåªä¼ å…ƒæ•°æ®
2. **æœ¬åœ°ä¼˜å…ˆ**: èµ„æºä¼˜å…ˆä»æœ¬åœ°è·å–
3. **è®¾å¤‡éš”ç¦»**: ä¸åŒè®¾å¤‡çš„éŸ³ä¹äº’ä¸å¯è§
4. **æœåŠ¡å™¨å…±äº«**: `device_id="server"` çš„éŸ³ä¹å…¨å±€å¯è§

---

## ğŸ’¾ æœ¬åœ°æ•°æ®åº“è®¾è®¡

### SQLite è¡¨ç»“æ„

```sql
-- èµ„æºæ˜ å°„è¡¨
CREATE TABLE resource_map (
    uuid TEXT PRIMARY KEY,
    resource_type TEXT NOT NULL,  -- 'music', 'cover', 'lyric'
    local_path TEXT NOT NULL,
    file_hash TEXT,               -- MD5 hash
    file_size INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_accessed TIMESTAMP
);

-- è®¾å¤‡ä¿¡æ¯è¡¨ï¼ˆç¼“å­˜ï¼‰
CREATE TABLE device_info (
    device_id TEXT PRIMARY KEY,
    device_name TEXT NOT NULL,
    device_type TEXT,
    platform TEXT,
    app_version TEXT,
    synced_at TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_resource_type ON resource_map(resource_type);
CREATE INDEX idx_local_path ON resource_map(local_path);
```

### Python å®ç°ç¤ºä¾‹

```python
import sqlite3
import os
from pathlib import Path

class LocalDatabase:
    def __init__(self, db_path="music_client.db"):
        self.conn = sqlite3.connect(db_path)
        self.create_tables()
    
    def create_tables(self):
        """åˆ›å»ºè¡¨"""
        cursor = self.conn.cursor()
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS resource_map (
                uuid TEXT PRIMARY KEY,
                resource_type TEXT NOT NULL,
                local_path TEXT NOT NULL,
                file_hash TEXT,
                file_size INTEGER,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                last_accessed TIMESTAMP
            )
        ''')
        
        cursor.execute('''
            CREATE INDEX IF NOT EXISTS idx_resource_type 
            ON resource_map(resource_type)
        ''')
        
        self.conn.commit()
    
    def add_mapping(self, uuid, resource_type, local_path, file_hash=None):
        """æ·»åŠ æ˜ å°„"""
        cursor = self.conn.cursor()
        file_size = os.path.getsize(local_path) if os.path.exists(local_path) else 0
        
        cursor.execute('''
            INSERT OR REPLACE INTO resource_map 
            (uuid, resource_type, local_path, file_hash, file_size)
            VALUES (?, ?, ?, ?, ?)
        ''', (uuid, resource_type, local_path, file_hash, file_size))
        
        self.conn.commit()
    
    def get_local_path(self, uuid):
        """è·å–æœ¬åœ°è·¯å¾„"""
        cursor = self.conn.cursor()
        cursor.execute(
            'SELECT local_path FROM resource_map WHERE uuid = ?',
            (uuid,)
        )
        result = cursor.fetchone()
        return result[0] if result else None
    
    def resource_exists_locally(self, uuid):
        """æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨äºæœ¬åœ°"""
        local_path = self.get_local_path(uuid)
        return local_path and os.path.exists(local_path)
```

---

## ğŸš€ åˆå§‹åŒ–æµç¨‹

### 1. ç”Ÿæˆè®¾å¤‡ UUID

```python
import uuid
import platform

def get_device_id():
    """
    è·å–æˆ–ç”Ÿæˆè®¾å¤‡ID
    é¦–æ¬¡è¿è¡Œæ—¶ç”Ÿæˆï¼Œåç»­ä»é…ç½®æ–‡ä»¶è¯»å–
    """
    config_file = "device_config.json"
    
    if os.path.exists(config_file):
        with open(config_file, 'r') as f:
            config = json.load(f)
            return config['device_id']
    
    # é¦–æ¬¡è¿è¡Œï¼Œç”Ÿæˆæ–°ID
    device_id = str(uuid.uuid4())
    
    config = {
        'device_id': device_id,
        'device_name': platform.node(),  # è®¡ç®—æœºå
        'device_type': get_device_type(),
        'platform': platform.system(),
    }
    
    with open(config_file, 'w') as f:
        json.dump(config, f, indent=2)
    
    return device_id

def get_device_type():
    """åˆ¤æ–­è®¾å¤‡ç±»å‹"""
    system = platform.system()
    if system in ['Windows', 'Darwin', 'Linux']:
        return 'desktop'
    elif system in ['Android', 'iOS']:
        return 'mobile'
    return 'other'
```

### 2. åˆå§‹åŒ– HTTP å®¢æˆ·ç«¯ï¼ˆé…ç½® X-Device-IDï¼‰

```python
import requests

def init_http_client(device_id: str) -> requests.Session:
    """
    åˆå§‹åŒ– HTTP å®¢æˆ·ç«¯ï¼Œç»Ÿä¸€é…ç½® X-Device-ID è¯·æ±‚å¤´
    æ¨èæ–¹å¼ï¼šåœ¨ Session ä¸­é…ç½®å…¨å±€è¯·æ±‚å¤´
    """
    session = requests.Session()
    session.headers.update({
        "X-Device-ID": device_id,  # ç»Ÿä¸€é…ç½®è®¾å¤‡ID
        "Content-Type": "application/json",
        # å¦‚éœ€è®¤è¯ï¼Œæ·»åŠ  Authorization
        # "Authorization": f"Bearer {token}",
    })
    return session

# JavaScript/TypeScript ç¤ºä¾‹
# const axios = require('axios');
# 
# function initHttpClient(deviceId) {
#   return axios.create({
#     baseURL: 'http://your-server.com',
#     headers: {
#       'X-Device-ID': deviceId,
#       'Content-Type': 'application/json'
#     }
#   });
# }
```

### 3. æ³¨å†Œè®¾å¤‡åˆ°æœåŠ¡å™¨

```python
import requests

def register_device(server_url, token, device_info):
    """æ³¨å†Œè®¾å¤‡"""
    response = requests.post(
        f"{server_url}/device/register",
        headers={"Authorization": f"Bearer {token}"},
        json={
            "device_id": device_info['device_id'],
            "device_name": device_info['device_name'],
            "device_type": device_info['device_type'],
            "platform": device_info['platform'],
            "app_version": "1.0.0"
        }
    )
    
    if response.status_code == 200:
        print("è®¾å¤‡æ³¨å†ŒæˆåŠŸ")
        return response.json()
    else:
        print(f"è®¾å¤‡æ³¨å†Œå¤±è´¥: {response.text}")
        return None
```

---

## ğŸµ éŸ³ä¹æ·»åŠ æµç¨‹

### å®Œæ•´æµç¨‹

```python
import hashlib
from mutagen import File as MutagenFile

def add_local_music(file_path, db, server_url, token, device_id):
    """
    æ·»åŠ æœ¬åœ°éŸ³ä¹å®Œæ•´æµç¨‹
    
    1. æå–å…ƒæ•°æ®
    2. è®¡ç®— MD5
    3. ç”Ÿæˆ UUID
    4. ä¿å­˜æœ¬åœ°æ˜ å°„
    5. ä¸Šä¼ å…ƒæ•°æ®åˆ°æœåŠ¡å™¨
    """
    
    # 1. æå–å…ƒæ•°æ®
    audio = MutagenFile(file_path)
    if not audio:
        raise ValueError("æ— æ³•è§£æéŸ³é¢‘æ–‡ä»¶")
    
    metadata = extract_metadata(audio, file_path)
    
    # 2. è®¡ç®— MD5
    md5_hash = calculate_md5(file_path)
    
    # 3. ç”Ÿæˆ UUID
    music_uuid = str(uuid.uuid4())
    
    # 4. ä¿å­˜æœ¬åœ°æ˜ å°„
    db.add_mapping(music_uuid, "music", file_path, md5_hash)
    
    # 5. å‡†å¤‡ä¸Šä¼ æ•°æ®
    music_data = {
        "uuid": music_uuid,
        "md5": md5_hash,
        "device_id": device_id,
        "name": metadata['name'],
        "author": metadata['author'],
        "album": metadata['album'],
        "duration": metadata['duration'],
        "size": metadata['size'],
        "bitrate": metadata['bitrate'],
        "file_format": metadata['file_format'],
    }
    
    # 6. ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼ˆæ¨èï¼šä½¿ç”¨ Session é…ç½®å…¨å±€è¯·æ±‚å¤´ï¼‰
    session = init_http_client(device_id)  # X-Device-ID å·²é…ç½®
    response = session.post(
        f"{server_url}/music/add",
        json=music_data
    )
    
    # å¤‡é€‰æ–¹å¼ï¼šä½¿ç”¨æŸ¥è¯¢å‚æ•°ï¼ˆä¸æ¨èä½†ä»æ”¯æŒï¼‰
    # response = requests.post(
    #     f"{server_url}/music/add?device_id={device_id}",
    #     headers={"Authorization": f"Bearer {token}"},
    #     json=music_data
    # )
    
    if response.status_code == 200:
        print(f"éŸ³ä¹æ·»åŠ æˆåŠŸ: {metadata['name']}")
        return music_uuid
    else:
        # å›æ»šæœ¬åœ°æ˜ å°„
        db.delete_mapping(music_uuid)
        raise Exception(f"æœåŠ¡å™¨æ·»åŠ å¤±è´¥: {response.text}")


def extract_metadata(audio, file_path):
    """æå–éŸ³é¢‘å…ƒæ•°æ®"""
    return {
        "name": audio.get("title", [os.path.basename(file_path)])[0],
        "author": audio.get("artist", ["æœªçŸ¥"])[0],
        "album": audio.get("album", [""])[0],
        "duration": int(audio.info.length),
        "size": os.path.getsize(file_path),
        "bitrate": audio.info.bitrate // 1000,
        "file_format": os.path.splitext(file_path)[1][1:].lower(),
    }


def calculate_md5(file_path, chunk_size=8192):
    """è®¡ç®—æ–‡ä»¶ MD5"""
    md5 = hashlib.md5()
    with open(file_path, 'rb') as f:
        while chunk := f.read(chunk_size):
            md5.update(chunk)
    return md5.hexdigest()
```

---

## ğŸ“¦ èµ„æºè·å–ç­–ç•¥

### ä¼˜å…ˆçº§é€»è¾‘

```python
class ResourceManager:
    def __init__(self, local_db, server_url, token):
        self.db = local_db
        self.server_url = server_url
        self.token = token
        self.cache_dir = Path("cache")
        self.cache_dir.mkdir(exist_ok=True)
    
    def get_music_file(self, uuid):
        """
        è·å–éŸ³ä¹æ–‡ä»¶
        ä¼˜å…ˆçº§: æœ¬åœ° > æœåŠ¡å™¨
        """
        # 1. æ£€æŸ¥æœ¬åœ°æ˜ å°„
        local_path = self.db.get_local_path(uuid)
        if local_path and os.path.exists(local_path):
            print(f"ä»æœ¬åœ°è·å–: {local_path}")
            return local_path
        
        # 2. å°è¯•ä»æœåŠ¡å™¨ä¸‹è½½ï¼ˆå¦‚æœæ˜¯ server è®¾å¤‡çš„éŸ³ä¹ï¼‰
        print(f"UUID {uuid} åœ¨æœ¬åœ°ä¸å­˜åœ¨")
        return None
    
    def get_cover(self, cover_uuid):
        """
        è·å–å°é¢
        ä¼˜å…ˆçº§: æœ¬åœ° > ç¼“å­˜ > æœåŠ¡å™¨
        """
        # 1. æœ¬åœ°æ˜ å°„
        local_path = self.db.get_local_path(cover_uuid)
        if local_path and os.path.exists(local_path):
            return local_path
        
        # 2. ç¼“å­˜
        cache_path = self.cache_dir / f"{cover_uuid}.jpg"
        if cache_path.exists():
            return str(cache_path)
        
        # 3. ä»æœåŠ¡å™¨ä¸‹è½½
        try:
            response = requests.get(
                f"{self.server_url}/music/cover/{cover_uuid}",
                headers={"Authorization": f"Bearer {self.token}"}
            )
            
            if response.status_code == 200:
                with open(cache_path, 'wb') as f:
                    f.write(response.content)
                return str(cache_path)
        except Exception as e:
            print(f"ä¸‹è½½å°é¢å¤±è´¥: {e}")
        
        return None
    
    def get_thumbnail(self, cover_uuid):
        """è·å–ç¼©ç•¥å›¾ï¼ˆç”¨äºåˆ—è¡¨æ˜¾ç¤ºï¼‰"""
        cache_path = self.cache_dir / f"{cover_uuid}_thumb.jpg"
        
        if cache_path.exists():
            return str(cache_path)
        
        try:
            response = requests.get(
                f"{self.server_url}/music/thumbnail/{cover_uuid}",
                headers={"Authorization": f"Bearer {self.token}"}
            )
            
            if response.status_code == 200:
                with open(cache_path, 'wb') as f:
                    f.write(response.content)
                return str(cache_path)
        except Exception as e:
            print(f"ä¸‹è½½ç¼©ç•¥å›¾å¤±è´¥: {e}")
        
        return None
```

---

## ğŸŒ API è°ƒç”¨ç¤ºä¾‹

> **æ¨èæ–¹å¼**: ä½¿ç”¨ `X-Device-ID` è¯·æ±‚å¤´ä¼ é€’è®¾å¤‡IDï¼Œæ›´ç¬¦åˆ RESTful è§„èŒƒã€‚
> è¯¦ç»†è¯´æ˜è¯·å‚è€ƒï¼š[API Device ID ä½¿ç”¨æŒ‡å—](./api_device_id_usage.md)

### 1. è·å–éŸ³ä¹åˆ—è¡¨

```python
def get_music_list(session, server_url, page=1, page_size=20):
    """
    è·å–éŸ³ä¹åˆ—è¡¨ï¼ˆä½¿ç”¨è¯·æ±‚å¤´ï¼‰
    
    Args:
        session: å·²é…ç½® X-Device-ID çš„ requests.Session
        page: é¡µç 
        page_size: æ¯é¡µæ•°é‡
    """
    response = session.get(
        f"{server_url}/music/list",
        params={
            "page": page,
            "page_size": page_size
        }
    )
    
    if response.status_code == 200:
        data = response.json()
        return data['data']['list']
    else:
        raise Exception(f"è·å–åˆ—è¡¨å¤±è´¥: {response.text}")

# å…¼å®¹æ—§æ–¹å¼ï¼šä½¿ç”¨æŸ¥è¯¢å‚æ•°ï¼ˆä¸æ¨èï¼‰
def get_music_list_legacy(server_url, token, device_id, page=1, page_size=20):
    """ä½¿ç”¨æŸ¥è¯¢å‚æ•°æ–¹å¼ï¼ˆå‘åå…¼å®¹ï¼‰"""
    response = requests.get(
        f"{server_url}/music/list",
        headers={"Authorization": f"Bearer {token}"},
        params={
            "device_id": device_id,  # æŸ¥è¯¢å‚æ•°ä¼˜å…ˆçº§é«˜äºè¯·æ±‚å¤´
            "page": page,
            "page_size": page_size
        }
    )
    return response.json()['data']['list']
```

### 2. æœç´¢éŸ³ä¹

```python
def search_music(session, server_url, keyword, page=1, page_size=50):
    """æœç´¢éŸ³ä¹ï¼ˆä½¿ç”¨è¯·æ±‚å¤´ï¼‰"""
    response = session.get(
        f"{server_url}/music/search",
        params={
            "keyword": keyword,
            "page": page,
            "page_size": page_size
        }
    )
    
    if response.status_code == 200:
        return response.json()['data']['list']
    else:
        raise Exception(f"æœç´¢å¤±è´¥: {response.text}")
```

### 3. åˆ é™¤éŸ³ä¹

```python
def delete_music(session, server_url, uuid):
    """åˆ é™¤éŸ³ä¹ï¼ˆä½¿ç”¨è¯·æ±‚å¤´ï¼‰"""
    response = session.delete(f"{server_url}/music/{uuid}")
    
    if response.status_code == 200:
        print(f"åˆ é™¤æˆåŠŸ: {uuid}")
        return True
    else:
        print(f"åˆ é™¤å¤±è´¥: {response.text}")
        return False
```

### JavaScript ç¤ºä¾‹

```javascript
// åˆå§‹åŒ– Axios å®¢æˆ·ç«¯
const axios = require('axios');

const apiClient = axios.create({
  baseURL: 'http://your-server.com',
  headers: {
    'X-Device-ID': deviceId,  // ç»Ÿä¸€é…ç½®
    'Content-Type': 'application/json'
  }
});

// è·å–éŸ³ä¹åˆ—è¡¨
async function getMusicList(page = 1, pageSize = 20) {
  const response = await apiClient.get('/music/list', {
    params: { page, page_size: pageSize }
  });
  return response.data.data.list;
}

// æœç´¢éŸ³ä¹
async function searchMusic(keyword) {
  const response = await apiClient.get('/music/search', {
    params: { keyword, page: 1, page_size: 50 }
  });
  return response.data.data.list;
}

// åˆ é™¤éŸ³ä¹
async function deleteMusic(uuid) {
  await apiClient.delete(`/music/${uuid}`);
  console.log(`åˆ é™¤æˆåŠŸ: ${uuid}`);
}
```

---

## ğŸ”„ è¯·æ±‚å¤´ vs æŸ¥è¯¢å‚æ•°å¯¹æ¯”

| æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| **X-Device-ID è¯·æ±‚å¤´** | âœ… ç¬¦åˆ RESTful è§„èŒƒ<br>âœ… ç»Ÿä¸€é…ç½®ä¸€æ¬¡<br>âœ… URL æ›´ç®€æ´ | âš ï¸ éœ€è¦å®¢æˆ·ç«¯å‡çº§ | â­â­â­â­â­ |
| **æŸ¥è¯¢å‚æ•°** | âœ… å‘åå…¼å®¹<br>âœ… æ˜“äºè°ƒè¯• | âŒ URL å†—é•¿<br>âŒ æ¯æ¬¡éƒ½è¦ä¼ é€’ | â­â­â­ |

### ä¼˜å…ˆçº§è§„åˆ™

å½“åŒæ—¶æä¾›æŸ¥è¯¢å‚æ•°å’Œè¯·æ±‚å¤´æ—¶ï¼Œ**æŸ¥è¯¢å‚æ•°ä¼˜å…ˆçº§æ›´é«˜**ï¼Œç”¨äºæ˜¾å¼è¦†ç›–é»˜è®¤è®¾å¤‡IDã€‚

```python
# åœºæ™¯ï¼šä¸´æ—¶æŸ¥è¯¢å…¶ä»–è®¾å¤‡çš„éŸ³ä¹
session = init_http_client("device-A")  # é»˜è®¤è®¾å¤‡A

# æŸ¥è¯¢è®¾å¤‡Bçš„éŸ³ä¹ï¼ˆæŸ¥è¯¢å‚æ•°è¦†ç›–ï¼‰
response = session.get(
    f"{server_url}/music/list",
    params={"device_id": "device-B"}  # æ˜¾å¼è¦†ç›–
)
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: å°é¢å’Œæ­Œè¯å¦‚ä½•å…³è”ï¼Ÿ

**A**:
    
    return response.json()['data']['list']
```

### 3. åˆ é™¤éŸ³ä¹

```python
def delete_music(server_url, token, uuid, device_id, local_db):
    """
    åˆ é™¤éŸ³ä¹
    
    1. åˆ é™¤æœ¬åœ°æ–‡ä»¶
    2. åˆ é™¤æœ¬åœ°æ˜ å°„
    3. åˆ é™¤æœåŠ¡å™¨è®°å½•
    """
    # 1. è·å–æœ¬åœ°è·¯å¾„
    local_path = local_db.get_local_path(uuid)
    
    # 2. åˆ é™¤æœåŠ¡å™¨è®°å½•
    response = requests.delete(
        f"{server_url}/music/{uuid}",
        headers={"Authorization": f"Bearer {token}"},
        params={"device_id": device_id}
    )
    
    if response.status_code != 200:
        raise Exception(f"æœåŠ¡å™¨åˆ é™¤å¤±è´¥: {response.text}")
    
    # 3. åˆ é™¤æœ¬åœ°æ–‡ä»¶
    if local_path and os.path.exists(local_path):
        os.remove(local_path)
        print(f"æœ¬åœ°æ–‡ä»¶å·²åˆ é™¤: {local_path}")
    
    # 4. åˆ é™¤æœ¬åœ°æ˜ å°„
    local_db.delete_mapping(uuid)
    
    print(f"éŸ³ä¹åˆ é™¤æˆåŠŸ: {uuid}")
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•å¤„ç†åŒä¸€æ–‡ä»¶åœ¨å¤šä¸ªè®¾å¤‡ï¼Ÿ

**A**: æ¯ä¸ªè®¾å¤‡åˆ†åˆ«æ·»åŠ ï¼ŒæœåŠ¡å™¨é€šè¿‡ `(md5, device_id)` è”åˆå”¯ä¸€ç´¢å¼•åŒºåˆ†ã€‚ä¸åŒè®¾å¤‡çš„ç›¸åŒæ–‡ä»¶ä¼šæœ‰ä¸åŒçš„ UUIDã€‚

### Q2: å°é¢å’Œæ­Œè¯å¦‚ä½•åŒæ­¥ï¼Ÿ

**A**: 
- å®¢æˆ·ç«¯æ·»åŠ éŸ³ä¹æ—¶ï¼Œå¦‚æœæœ‰å°é¢/æ­Œè¯ï¼ŒåŒæ—¶ä¿å­˜æœ¬åœ°æ˜ å°„
- æœåŠ¡å™¨åªå­˜å‚¨ `cover_uuid` å’Œ `lyric` æ–‡æœ¬
- å…¶ä»–è®¾å¤‡ä»æœåŠ¡å™¨ä¸‹è½½åç¼“å­˜

### Q3: å¦‚ä½•å®ç°ç¦»çº¿æ’­æ”¾ï¼Ÿ

**A**:
- æœ¬åœ°éŸ³ä¹ï¼šç›´æ¥æ’­æ”¾ï¼Œæ— éœ€ç½‘ç»œ
- æœåŠ¡å™¨éŸ³ä¹ï¼šé¦–æ¬¡æ’­æ”¾æ—¶ä¸‹è½½å¹¶ç¼“å­˜
- ç¼“å­˜ç­–ç•¥ï¼šLRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰

### Q4: è®¾å¤‡åˆ‡æ¢å¦‚ä½•ä¿æŒéŸ³ä¹åº“ï¼Ÿ

**A**:
- æ¯ä¸ªè®¾å¤‡ç‹¬ç«‹éŸ³ä¹åº“
- æœåŠ¡å™¨éŸ³ä¹ï¼ˆdevice_id="server"ï¼‰å…¨å±€å¯è§
- å¯ä»¥åœ¨è®¾ç½®ä¸­"æŸ¥çœ‹æ‰€æœ‰è®¾å¤‡çš„éŸ³ä¹"

### Q5: MD5 å†²çªæ€ä¹ˆåŠï¼Ÿ

**A**:
- åŒä¸€è®¾å¤‡ï¼š`(md5, device_id)` å”¯ä¸€ï¼Œæ‹’ç»é‡å¤æ·»åŠ 
- ä¸åŒè®¾å¤‡ï¼šå…è®¸ç›¸åŒ MD5ï¼Œä¸åŒ UUID

---

## ğŸ“Š æ€§èƒ½å»ºè®®

1. **æ‰¹é‡æ“ä½œ**: æ·»åŠ å¤šé¦–éŸ³ä¹æ—¶ï¼Œå…ˆæœ¬åœ°å¤„ç†ï¼Œå†æ‰¹é‡ä¸Šä¼ 
2. **ç¼©ç•¥å›¾**: åˆ—è¡¨ä½¿ç”¨ç¼©ç•¥å›¾ï¼ˆ~20KBï¼‰ï¼Œè¯¦æƒ…é¡µåŠ è½½åŸå›¾
3. **æ‡’åŠ è½½**: éŸ³ä¹åˆ—è¡¨åˆ†é¡µåŠ è½½ï¼Œå°é¢å¼‚æ­¥åŠ è½½
4. **ç¼“å­˜ç­–ç•¥**: å°é¢/ç¼©ç•¥å›¾æ°¸ä¹…ç¼“å­˜ï¼ŒéŸ³ä¹æ–‡ä»¶æŒ‰ LRU
5. **æ•°æ®åº“ç´¢å¼•**: æœ¬åœ°æ•°æ®åº“å¯¹ uuid å’Œ resource_type å»ºç´¢å¼•

---

## ğŸ”’ å®‰å…¨å»ºè®®

1. **Token å­˜å‚¨**: ä½¿ç”¨ç³»ç»Ÿ Keychain/Keystore å­˜å‚¨
2. **HTTPS**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
3. **æ–‡ä»¶æƒé™**: éŸ³ä¹æ–‡ä»¶è®¾ç½®åˆé€‚çš„è¯»å†™æƒé™
4. **æ•°æ®åº“åŠ å¯†**: æ•æ„Ÿæ•°æ®è€ƒè™‘ä½¿ç”¨ SQLCipher

---

## ğŸ“± å¹³å°ç‰¹å®šå»ºè®®

### iOS
- ä½¿ç”¨ Core Data æˆ– SQLite.swift
- å°é¢ç¼“å­˜ä½¿ç”¨ FileManager
- åå°ä¸‹è½½ä½¿ç”¨ URLSession

### Android
- ä½¿ç”¨ Room æ•°æ®åº“
- å°é¢ç¼“å­˜ä½¿ç”¨ Glide/Coil
- MediaStore é›†æˆ

### Desktop (Electron/Qt)
- SQLite3 æ•°æ®åº“
- æœ¬åœ°æ–‡ä»¶ç®¡ç†
- ç³»ç»Ÿæ‰˜ç›˜é›†æˆ

---

## ğŸ¯ æ€»ç»“

å®¢æˆ·ç«¯å®ç°çš„æ ¸å¿ƒè¦ç‚¹ï¼š

1. âœ… æœ¬åœ°æ•°æ®åº“ç»´æŠ¤ UUID â†’ æ–‡ä»¶è·¯å¾„æ˜ å°„
2. âœ… ä¼˜å…ˆä½¿ç”¨æœ¬åœ°èµ„æºï¼Œé™çº§åˆ°æœåŠ¡å™¨
3. âœ… æ–‡ä»¶è·¯å¾„æ°¸ä¸ä¸Šä¼ ï¼Œä¿æŠ¤éšç§
4. âœ… è®¾å¤‡éš”ç¦»ï¼Œå„è‡ªç®¡ç†éŸ³ä¹åº“
5. âœ… æœåŠ¡å™¨éŸ³ä¹å…¨å±€å…±äº«

å®Œæ•´ç¤ºä¾‹ä»£ç è¯·å‚è€ƒ: [å®¢æˆ·ç«¯ç¤ºä¾‹é¡¹ç›®](https://github.com/your-repo/music-client-example)
